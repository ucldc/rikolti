There's some DRY violations in here. It'd be nice to fix them, but would add some weird complexity.